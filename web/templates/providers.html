{% extends "base.html" %}
{% block title %}Provider 管理 - AnyRouter Check-in{% endblock %}
{% block content %}
<div class="max-w-5xl">
	<div class="flex items-center justify-between mb-8">
		<div class="relative">
			<h2 class="text-3xl font-black tracking-tight text-black">Provider 管理</h2>
			<div class="absolute -top-2 -left-4 w-4 h-4 bg-[#1dd1a1] border-2 border-black rotate-45"></div>
		</div>
		<button onclick="showAddProviderModal()"
			class="bg-[#ff9ff3] text-black px-6 py-3 border-4 border-black font-black text-sm shadow-[6px_6px_0px_#000] transition-all duration-150 hover:bg-[#48dbfb] hover:shadow-[8px_8px_0px_#000] active:translate-x-[6px] active:translate-y-[6px] active:shadow-none inline-flex items-center">
			<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
			添加 Provider
		</button>
	</div>

	<div class="border-4 border-black bg-white shadow-[8px_8px_0px_#000] overflow-hidden">
		<table class="w-full text-sm">
			<thead class="bg-[#1dd1a1] border-b-4 border-black">
				<tr>
					<th class="text-left px-4 py-3 font-black text-black text-xs">名称</th>
					<th class="text-left px-4 py-3 font-black text-black text-xs">域名</th>
					<th class="text-left px-4 py-3 font-black text-black text-xs">WAF 绕过</th>
					<th class="text-left px-4 py-3 font-black text-black text-xs">类型</th>
					<th class="text-right px-4 py-3 font-black text-black text-xs">操作</th>
				</tr>
			</thead>
			<tbody>
				{% for p in providers %}
				<tr class="border-b-4 border-black {% if loop.index is odd %}bg-white{% else %}bg-[#f5e6cc]{% endif %}">
					<td class="px-4 py-3 font-black text-black">{{ p.name }}</td>
					<td class="px-4 py-3 font-bold text-black font-mono text-xs">{{ p.domain }}</td>
					<td class="px-4 py-3">
						{% if p.bypass_method %}
						<span class="inline-flex px-2 py-0.5 border-4 border-black text-xs font-black bg-[#feca57] text-black">{{ p.bypass_method }}</span>
						{% else %}
						<span class="font-bold text-black text-xs">无</span>
						{% endif %}
					</td>
					<td class="px-4 py-3">
						{% if p.is_builtin %}
						<span class="inline-flex px-2 py-0.5 border-4 border-black text-xs font-black bg-[#48dbfb] text-black">内置</span>
						{% else %}
						<span class="inline-flex px-2 py-0.5 border-4 border-black text-xs font-black bg-[#ff9ff3] text-black">自定义</span>
						{% endif %}
					</td>
					<td class="px-4 py-3 text-right space-x-1">
						{% if not p.is_builtin %}
						<button onclick="showEditProviderModal({{ p|tojson }})"
							class="px-2 py-1 border-4 border-black text-xs font-black bg-[#48dbfb] shadow-[2px_2px_0px_#000] transition-all duration-150 hover:bg-[#feca57] active:translate-x-[2px] active:translate-y-[2px] active:shadow-none">编辑</button>
						<button onclick="deleteProvider('{{ p.name }}')"
							class="px-2 py-1 border-4 border-black text-xs font-black bg-[#ff6b6b] text-white shadow-[2px_2px_0px_#000] transition-all duration-150 hover:bg-[#ff9ff3] hover:text-black active:translate-x-[2px] active:translate-y-[2px] active:shadow-none">删除</button>
						{% else %}
						<span class="text-xs font-black text-black">只读</span>
						{% endif %}
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

<!-- Provider Modal -->
<div id="provider-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center" onclick="if(event.target===this)closeProviderModal()">
	<div class="bg-[#1dd1a1] border-4 border-black shadow-[8px_8px_0px_#000] w-full max-w-lg mx-4 p-6 relative">
		<div class="absolute -top-4 -right-4 w-10 h-10 bg-[#feca57] rounded-full border-4 border-black"></div>
		<div class="absolute -bottom-3 -left-3 w-0 h-0 border-l-[14px] border-l-transparent border-r-[14px] border-r-transparent border-t-[18px] border-t-[#ff6b6b]"></div>
		<h3 id="provider-modal-title" class="text-xl font-black text-black mb-5">添加 Provider</h3>
		<form id="provider-form" onsubmit="submitProvider(event)">
			<input type="hidden" id="provider-edit-name" value="">
			<div class="space-y-4">
				<div>
					<label class="block text-sm font-black text-black mb-1">预设模板</label>
					<select id="pf-template" onchange="applyProviderTemplate(this.value)" class="w-full px-4 py-2.5 bg-white border-4 border-black text-black font-bold focus:outline-none shadow-[4px_4px_0px_#feca57]">
						<option value="new-api">new-api 标准模板</option>
						<option value="agentrouter">agentrouter 自动签到模板</option>
						<option value="custom">完全自定义</option>
					</select>
					<p class="text-xs font-bold text-black/80 mt-1">模板仅填充建议值，仍可手动修改全部字段。</p>
				</div>
				<div>
					<label class="block text-sm font-black text-black mb-1">名称 (唯一标识)</label>
					<input type="text" id="pf-name" required class="w-full px-4 py-2.5 bg-white border-4 border-black text-black font-bold placeholder:text-black/30 focus:outline-none shadow-[4px_4px_0px_#feca57] transition-all duration-150" placeholder="例如：myrouter">
				</div>
				<div>
					<label class="block text-sm font-black text-black mb-1">域名</label>
					<input type="url" id="pf-domain" list="provider-domain-suggestions" required class="w-full px-4 py-2.5 bg-white border-4 border-black text-black font-bold placeholder:text-black/30 focus:outline-none shadow-[4px_4px_0px_#feca57] transition-all duration-150" placeholder="https://example.com">
				</div>
				<div class="grid grid-cols-2 gap-3">
					<div>
						<label class="block text-sm font-black text-black mb-1">登录路径</label>
						<input type="text" id="pf-login-path" list="provider-login-path-suggestions" value="/login" class="w-full px-3 py-2 bg-white border-4 border-black text-black font-bold focus:outline-none shadow-[3px_3px_0px_#48dbfb] transition-all duration-150 text-sm">
					</div>
					<div>
						<label class="block text-sm font-black text-black mb-1">签到路径</label>
						<input type="text" id="pf-signin-path" list="provider-signin-path-suggestions" value="/api/user/sign_in" class="w-full px-3 py-2 bg-white border-4 border-black text-black font-bold focus:outline-none shadow-[3px_3px_0px_#48dbfb] transition-all duration-150 text-sm">
					</div>
				</div>
				<div class="grid grid-cols-2 gap-3">
					<div>
						<label class="block text-sm font-black text-black mb-1">用户信息路径</label>
						<input type="text" id="pf-userinfo-path" list="provider-userinfo-path-suggestions" value="/api/user/self" class="w-full px-3 py-2 bg-white border-4 border-black text-black font-bold focus:outline-none shadow-[3px_3px_0px_#48dbfb] transition-all duration-150 text-sm">
					</div>
					<div>
						<label class="block text-sm font-black text-black mb-1">API User Key</label>
						<input type="text" id="pf-api-user-key" list="provider-api-user-key-suggestions" value="new-api-user" class="w-full px-3 py-2 bg-white border-4 border-black text-black font-bold focus:outline-none shadow-[3px_3px_0px_#48dbfb] transition-all duration-150 text-sm">
					</div>
				</div>
				<div>
					<label class="block text-sm font-black text-black mb-1">WAF 绕过方式</label>
					<input type="text" id="pf-bypass" list="provider-bypass-suggestions" class="w-full px-4 py-2.5 bg-white border-4 border-black text-black font-bold placeholder:text-black/30 focus:outline-none shadow-[4px_4px_0px_#feca57] transition-all duration-150" placeholder="例如：waf_cookies；留空表示无">
				</div>
				<div>
					<label class="block text-sm font-black text-black mb-1">WAF Cookie 名称 (逗号分隔)</label>
					<input type="text" id="pf-waf-cookies" class="w-full px-4 py-2.5 bg-white border-4 border-black text-black font-bold placeholder:text-black/30 focus:outline-none shadow-[4px_4px_0px_#feca57] transition-all duration-150" placeholder="acw_tc, cdn_sec_tc">
				</div>
			</div>
			<datalist id="provider-domain-suggestions">
				<option value="https://new-api.example.com"></option>
				<option value="https://anyrouter.top"></option>
				<option value="https://agentrouter.org"></option>
			</datalist>
			<datalist id="provider-login-path-suggestions">
				<option value="/login"></option>
			</datalist>
			<datalist id="provider-signin-path-suggestions">
				<option value="/api/user/sign_in"></option>
				<option value="/api/user/checkin"></option>
			</datalist>
			<datalist id="provider-userinfo-path-suggestions">
				<option value="/api/user/self"></option>
				<option value="/api/user/info"></option>
			</datalist>
			<datalist id="provider-api-user-key-suggestions">
				<option value="new-api-user"></option>
				<option value="New-Api-User"></option>
			</datalist>
			<datalist id="provider-bypass-suggestions">
				<option value="waf_cookies"></option>
			</datalist>
			<div class="flex justify-end space-x-3 mt-6">
				<button type="button" onclick="closeProviderModal()" class="px-5 py-2.5 border-4 border-black bg-white text-black font-black text-sm shadow-[4px_4px_0px_#000] transition-all duration-150 hover:bg-pink-300 hover:shadow-[6px_6px_0px_#000] active:translate-x-[4px] active:translate-y-[4px] active:shadow-none">取消</button>
				<button type="submit" class="px-5 py-2.5 border-4 border-black bg-[#feca57] text-black font-black text-sm shadow-[4px_4px_0px_#000] transition-all duration-150 hover:bg-[#48dbfb] hover:shadow-[6px_6px_0px_#000] active:translate-x-[4px] active:translate-y-[4px] active:shadow-none">保存</button>
			</div>
		</form>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
const PROVIDER_TEMPLATES = {
	'new-api': {
		domain: 'https://new-api.example.com',
		login_path: '/login',
		sign_in_path: '/api/user/sign_in',
		user_info_path: '/api/user/self',
		api_user_key: 'new-api-user',
		bypass_method: 'waf_cookies',
		waf_cookie_names: ['acw_tc'],
	},
	agentrouter: {
		domain: 'https://agentrouter.org',
		login_path: '/login',
		sign_in_path: '',
		user_info_path: '/api/user/self',
		api_user_key: 'new-api-user',
		bypass_method: 'waf_cookies',
		waf_cookie_names: ['acw_tc'],
	},
};

function applyProviderTemplate(templateName) {
	const template = PROVIDER_TEMPLATES[templateName];
	if (!template) return;
	document.getElementById('pf-domain').value = template.domain;
	document.getElementById('pf-login-path').value = template.login_path;
	document.getElementById('pf-signin-path').value = template.sign_in_path;
	document.getElementById('pf-userinfo-path').value = template.user_info_path;
	document.getElementById('pf-api-user-key').value = template.api_user_key;
	document.getElementById('pf-bypass').value = template.bypass_method || '';
	document.getElementById('pf-waf-cookies').value = (template.waf_cookie_names || []).join(', ');
}

function detectTemplate(p) {
	for (const [name, template] of Object.entries(PROVIDER_TEMPLATES)) {
		const wafNames = (() => { try { return JSON.parse(p.waf_cookie_names || '[]'); } catch(e) { return []; } })();
		const wafMatched = JSON.stringify(wafNames) === JSON.stringify(template.waf_cookie_names || []);
		if (
			(p.domain || '') === (template.domain || '')
			&& (p.login_path || '') === (template.login_path || '')
			&& (p.sign_in_path || '') === (template.sign_in_path || '')
			&& (p.user_info_path || '') === (template.user_info_path || '')
			&& (p.api_user_key || '') === (template.api_user_key || '')
			&& (p.bypass_method || '') === (template.bypass_method || '')
			&& wafMatched
		) {
			return name;
		}
	}
	return 'custom';
}

function showAddProviderModal() {
	document.getElementById('provider-modal-title').textContent = '添加 Provider';
	document.getElementById('provider-edit-name').value = '';
	document.getElementById('pf-name').value = ''; document.getElementById('pf-name').disabled = false;
	document.getElementById('pf-template').value = 'new-api';
	applyProviderTemplate('new-api');
	document.getElementById('provider-modal').classList.remove('hidden');
	document.getElementById('provider-modal').classList.add('flex');
}
function showEditProviderModal(p) {
	document.getElementById('provider-modal-title').textContent = '编辑 Provider';
	document.getElementById('provider-edit-name').value = p.name;
	document.getElementById('pf-name').value = p.name; document.getElementById('pf-name').disabled = true;
	document.getElementById('pf-domain').value = p.domain;
	document.getElementById('pf-login-path').value = p.login_path == null ? '/login' : p.login_path;
	document.getElementById('pf-signin-path').value = p.sign_in_path == null ? '/api/user/sign_in' : p.sign_in_path;
	document.getElementById('pf-userinfo-path').value = p.user_info_path == null ? '/api/user/self' : p.user_info_path;
	document.getElementById('pf-api-user-key').value = p.api_user_key == null ? 'new-api-user' : p.api_user_key;
	document.getElementById('pf-bypass').value = p.bypass_method || '';
	let wafNames = ''; try { wafNames = JSON.parse(p.waf_cookie_names || '[]').join(', '); } catch(e) {}
	document.getElementById('pf-waf-cookies').value = wafNames;
	document.getElementById('pf-template').value = detectTemplate(p);
	document.getElementById('provider-modal').classList.remove('hidden');
	document.getElementById('provider-modal').classList.add('flex');
}
function closeProviderModal() {
	document.getElementById('provider-modal').classList.add('hidden');
	document.getElementById('provider-modal').classList.remove('flex');
}
async function submitProvider(e) {
	e.preventDefault();
	const editName = document.getElementById('provider-edit-name').value;
	const wafStr = document.getElementById('pf-waf-cookies').value;
	const wafCookies = wafStr ? wafStr.split(',').map(s => s.trim()).filter(Boolean) : [];
	const bypassValue = document.getElementById('pf-bypass').value.trim();
	const data = { name: document.getElementById('pf-name').value, domain: document.getElementById('pf-domain').value, login_path: document.getElementById('pf-login-path').value, sign_in_path: document.getElementById('pf-signin-path').value, user_info_path: document.getElementById('pf-userinfo-path').value, api_user_key: document.getElementById('pf-api-user-key').value, bypass_method: bypassValue || null, waf_cookie_names: wafCookies };
	const url = editName ? `/api/providers/${editName}` : '/api/providers';
	const method = editName ? 'PUT' : 'POST';
	const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
	const result = await res.json();
	if (result.success) { showToast(editName ? 'Provider 已更新' : 'Provider 已添加', 'success'); setTimeout(() => location.reload(), 500); }
	else { showToast(result.message || '操作失败', 'error'); }
}
async function deleteProvider(name) {
	if (!confirm(`确定删除 Provider "${name}" 吗？`)) return;
	const res = await fetch(`/api/providers/${name}`, { method: 'DELETE' });
	const result = await res.json();
	if (result.success) { showToast('Provider 已删除', 'success'); setTimeout(() => location.reload(), 500); }
	else { showToast(result.message || '删除失败', 'error'); }
}
</script>
{% endblock %}
