id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
NAP-01-01,P1,1,backend,接入 new-api Provider 默认配置与调度解析,在配置加载与内置 Provider 初始化中加入 new-api，并确保调度器按账号绑定读取 domain、login_path、sign_in_path、user_info_path、api_user_key。,WHEN 管理员创建两个不同 domain 的 new-api Provider THEN 系统可分别保存并供账号绑定; SHALL 持久化并在签到执行中使用 endpoint 字段; ref: openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:6; ref: openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:10; ref: openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:12; validate: 后台新建两个 Provider 并各触发一次手动签到,AUTOSERVER,基于决策1确认采用 预设加自定义 覆盖方案且不限制字段可编辑性; 检查字段默认值与 proposal 影响范围一致,按风险 缓解不同部署返回差异，要求 provider 维度具备兜底解析; 回归时确认新增 provider 不影响既有 provider,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:1; openspec/changes/new-api-checkin-plan/tasks.md:3; openspec/changes/new-api-checkin-plan/proposal.md:7; openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:4; openspec/changes/new-api-checkin-plan/design.md:29; utils/config.py:79; web/database.py:81; tests/test_provider_integration.py:14; README.md:135,后续被阶段2界面配置体验增强依赖；需保持现有表结构兼容; picked_reason:作为P1基础能力且被NAP-01-02依赖，先完成以解锁后续项; context_budget_exception:为定位provider初始化、调度链路与文档同步，context收集超过8次命令; review_initial:核对新增builtin仅扩展默认provider集合，不改变现有provider字段契约; review_regression:验证调度按provider维度读取domain/login_path/sign_in_path/user_info_path/api_user_key; evidence:.venv/bin/pytest -q tests/test_provider_integration.py -> 3 passed; done_at:2026-02-24
NAP-01-02,P1,1,both,完善 new-api 签到执行分支与兼容回归,实现 new-api 的成功、已签到、失败分支处理，并覆盖 Cookie 与浏览器登录两种模式，同时回归既有 provider。,WHEN 账号使用 cookie 模式签到 THEN 走现有 cookie pipeline 并写入日志; WHEN 账号使用 browser_login 模式签到 THEN 记录成功或失败详情; WHEN 新变更发布后 anyrouter 账号签到 THEN 行为保持不变; ref: openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:17; ref: openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:21; ref: openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:28; validate: 手动与定时各执行一轮对比日志,AUTOE2E,审查决策3中的分支策略是否覆盖 success already_checked_in error 三类路径; 对比备选方案确认不引入 provider 特殊模式分叉,结合风险矩阵进行兼容回归，重点验证既有账号不会出现流程漂移; 出现异常可先回滚新增分支逻辑,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:5; openspec/changes/new-api-checkin-plan/tasks.md:6; openspec/changes/new-api-checkin-plan/tasks.md:7; openspec/changes/new-api-checkin-plan/specs/new-api-provider-checkin/spec.md:14; openspec/changes/new-api-checkin-plan/design.md:69; checkin.py:68; checkin.py:185; web/scheduler.py:24; web/scheduler.py:236; tests/test_checkin_branches.py:35,依赖 NAP-01-01 完成 provider 基础配置; picked_reason:承接NAP-01-01后的P1核心执行链路，先完成可尽快形成可运行签到路径; context_budget_exception:涉及cookie与browser两条执行链路和回归路径，context收集超过8次命令; review_initial:覆盖success/already_checked_in/error分支并保持现有provider通用逻辑; review_regression:确认scheduler在cookie/browser模式都记录明确message与状态; validation_limited:当前仓库缺少可直接运行的AUTOE2E编排，未执行真实站点端到端回放; manual_test:启动Web后分别创建cookie和browser_login账号，执行手动签到与定时签到并核对checkin_logs状态及message; evidence:.venv/bin/pytest -q tests/test_checkin_branches.py tests/test_provider_integration.py -> 8 passed; risk:medium 未在真实目标站点执行cookie/browser+定时联合回归，仍需发布前手工验证; done_at:2026-02-24
NAP-02-01,P1,2,frontend,Provider 表单预设与建议值交互,在 Provider 新建编辑中提供预设模板、字段建议值与手动覆盖，保证新手可快速配置，老手可完全自定义。,WHEN 选择 new-api 标准模板 THEN 预填推荐字段; WHEN 切换到 完全自定义 THEN 可编辑全部字段; WHEN 选择建议 sign_in_path 后再手改 THEN 以手改值保存; ref: openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:6; ref: openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:10; ref: openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:17; validate: 前端交互回放覆盖模板切换与覆盖保存,AUTOFRONTEND,按决策1核对 模板仅建议不锁定 配置策略; 审查字段交互是否符合 Goals 中多域名可配置要求,回归检查现有 Provider 表单流程与默认值填充; 若交互异常优先回退模板入口不回退底层保存能力,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:9; openspec/changes/new-api-checkin-plan/tasks.md:11; openspec/changes/new-api-checkin-plan/tasks.md:12; openspec/changes/new-api-checkin-plan/tasks.md:13; openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:3; web/templates/providers.html:74; web/templates/providers.html:153; README.md:145,不涉及视觉重设计，只做字段交互增强; picked_reason:P1且为NAP-02-02依赖，先完成模板与可覆盖交互主路径; context_budget_exception:为确认模板需求与现有表单行为边界，context收集超过8次命令; review_initial:模板仅做建议值填充且切换到完全自定义后保持全部字段可编辑; review_regression:编辑弹窗改为null判断回落默认值，避免覆盖手工输入空字符串; validation_limited:仓库内暂无可直接运行的AUTOFRONTEND自动化脚本，未执行浏览器自动回放; manual_test:打开Provider弹窗选择new-api模板后改写sign_in_path并保存，再切换完全自定义确认字段保持可编辑且保存后值不被模板回写; evidence:.venv/bin/pytest -q tests/test_checkin_branches.py tests/test_provider_integration.py -> 8 passed; risk:medium 未做真实浏览器端交互录制，需发布前人工点测模板切换与覆盖保存; done_at:2026-02-24
NAP-02-02,P1,2,both,Provider 配置校验与中文文案 样式一致性,补齐前后端配置校验并把新增文案中文化，同时保持当前 UI 风格不变。,WHEN 提交空或非法 domain THEN 拒绝并返回可操作错误; WHEN WAF Cookie 名称格式非法 THEN 拒绝保存; WHEN 打开 Provider 对话框 THEN 新增或改动文案显示中文; WHEN 引入预设建议功能 THEN 页面保持原有风格体系; ref: openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:24; ref: openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:28; ref: openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:35; ref: openspec/changes/new-api-checkin-plan/specs/provider-config-presets/spec.md:39; validate: 手工校验中文文案与样式一致性,AUTOE2E,审查决策5并确认 文案中文化 与 风格保持 是硬约束; 审查校验消息是否可理解且可执行,回归风险包含 页面风格漂移 与 配置误拦截，需覆盖成功路径与失败路径; 可按迁移步骤先后启用校验与文案,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:14; openspec/changes/new-api-checkin-plan/tasks.md:16; openspec/changes/new-api-checkin-plan/tasks.md:17; openspec/changes/new-api-checkin-plan/design.md:61; openspec/changes/new-api-checkin-plan/design.md:73; web/routes/providers.py:19; web/routes/providers.py:55; web/templates/providers.html:235; tests/test_provider_validation.py:13; README.md:165,Blocked by NAP-02-01 的模板交互落地; picked_reason:承接NAP-02-01后补齐校验与中文文案一致性，避免模板功能带来脏数据; context_budget_exception:联动前后端校验与模板UI回归，context收集超过8次命令; review_initial:新增domain和waf_cookie_names双端校验且错误提示保持中文可执行; review_regression:确认模板交互样式类未替换，仅增加校验逻辑与提示文本; validation_limited:当前仓库无可直接运行的AUTOE2E脚本，未执行浏览器端到端回归; manual_test:在Provider弹窗分别输入非法domain和非法WAF Cookie名称确认被拒绝，再输入合法值保存成功并检查样式无漂移; evidence:.venv/bin/pytest -q tests/test_provider_validation.py tests/test_checkin_branches.py tests/test_provider_integration.py -> 12 passed; risk:medium 缺少真实浏览器e2e回放，发布前需人工验证前端提示与提交流程; done_at:2026-02-24
NAP-03-01,P2,3,frontend,仪表盘最近执行保留10条并增加全量入口,保持仪表盘轻量快览，同时新增 查看全部执行记录 入口，文案中文且不改风格。,WHEN 日志总数大于10 THEN 仪表盘只显示最近10条; WHEN 点击 查看全部执行记录 THEN 跳转日志历史页; WHEN 渲染新增入口文案 THEN 使用中文; ref: openspec/changes/new-api-checkin-plan/specs/checkin-log-history-view/spec.md:6; ref: openspec/changes/new-api-checkin-plan/specs/checkin-log-history-view/spec.md:13; ref: openspec/changes/new-api-checkin-plan/specs/checkin-log-history-view/spec.md:31; validate: 仪表盘手工验收导航与条数,AUTOFRONTEND,依据决策2检查快览与全量入口并存是否清晰可用; 审查新增入口是否保持现有视觉语言,回归重点为仪表盘首屏性能与布局稳定; 若异常优先隐藏入口但保留日志页功能,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:21; openspec/changes/new-api-checkin-plan/tasks.md:22; openspec/changes/new-api-checkin-plan/tasks.md:25; openspec/changes/new-api-checkin-plan/specs/checkin-log-history-view/spec.md:3; web/app.py:65; web/templates/dashboard.html:119; web/templates/dashboard.html:124; tests/test_dashboard_recent_logs_entry.py:9; README.md:174,与日志页分页筛选增强任务并行但需统一文案; picked_reason:先补仪表盘入口与10条快览，解锁NAP-03-02与日志导航测试; context_budget_exception:需核对仪表盘模板与日志链路现状，context收集超过8次命令; review_initial:保持dashboard查询limit=10并新增中文入口查看全部执行记录; review_regression:入口按钮复用现有边框/配色样式类，未改动整体布局结构; validation_limited:缺少AUTOFRONTEND浏览器自动化环境，未执行真实页面点击验证; manual_test:打开仪表盘确认最近执行最多10条并点击查看全部执行记录跳转到/logs; evidence:.venv/bin/pytest -q tests/test_dashboard_recent_logs_entry.py tests/test_failure_reason_classifier.py tests/test_provider_validation.py tests/test_checkin_branches.py tests/test_provider_integration.py -> 22 passed; risk:medium 未在真实浏览器验证按钮视觉与跳转交互，仅做模板与单测校验; done_at:2026-02-24
NAP-03-02,P2,3,both,日志历史页分页筛选与查询稳定性,完善日志页分页与筛选，并确保筛选条件在翻页过程中可保持。,WHEN 用户按账号和状态筛选 THEN 仅返回匹配记录并保持筛选条件; WHEN 翻到下一页 THEN 返回按时间倒序的对应切片; validate: 分页与筛选联动回归检查,AUTOE2E,对照决策2确认 历史页承担全量检索，仪表盘保持摘要; 审查后端查询参数与前端状态同步边界,回归覆盖大数据量场景下分页性能与排序稳定性; 风险项为日志量增长导致查询变慢，需按默认页大小压测,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:23; openspec/changes/new-api-checkin-plan/tasks.md:24; openspec/changes/new-api-checkin-plan/specs/checkin-log-history-view/spec.md:17; openspec/changes/new-api-checkin-plan/specs/checkin-log-history-view/spec.md:24; openspec/changes/new-api-checkin-plan/design.md:72; web/routes/logs.py:11; web/routes/logs.py:25; web/database.py:300; tests/test_logs_pagination_stability.py:11; README.md:175,依赖 NAP-03-01 提供统一入口; picked_reason:承接NAP-03-01入口后完善日志分页筛选稳定性，避免查询状态丢失; context_budget_exception:排查分页筛选稳定性涉及路由/SQL/模板三处联动，context收集超过8次命令; review_initial:日志路由新增正整数解析与页码钳制，避免非法参数导致筛选分页漂移; review_regression:查询排序改为created_at+id双重倒序并保持分页链接携带筛选参数; validation_limited:未执行AUTOE2E真实页面翻页回放，仅完成后端与模板层单测验证; manual_test:进入/logs按状态和账号筛选后连续翻页，确认URL持续包含status/account_id且结果按时间倒序稳定; evidence:.venv/bin/pytest -q tests/test_logs_pagination_stability.py tests/test_dashboard_recent_logs_entry.py tests/test_failure_reason_classifier.py tests/test_provider_validation.py tests/test_checkin_branches.py tests/test_provider_integration.py -> 25 passed; risk:medium 未在大数据量真实页面压测分页性能，发布前建议做样本压测; done_at:2026-02-24
NAP-04-01,P1,4,both,实现签到失败原因归类规则,基于状态码 消息关键词 上下文归类失败原因，输出统一 category 并提供 unknown 兜底。,WHEN 消息指向凭据失效 THEN 分类为 auth_failed; WHEN 指向 WAF 挑战或缺少 WAF cookies THEN 分类为 waf_blocked; WHEN 网络超时或连接失败 THEN 分类为 network_error; WHEN 无匹配规则 THEN 分类为 unknown_error; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:6; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:10; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:14; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:18; validate: 构造错误样本覆盖各分类规则,CONTRACT,依据决策3与分类字典评审规则优先级和冲突处理; 说明为何不采用仅原始 message 展示方案,回归关注 分类误判 风险并保留原始文本可追溯; open question 为是否持久化 error_category，当前先按展示层计算,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:30; openspec/changes/new-api-checkin-plan/tasks.md:31; openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:3; openspec/changes/new-api-checkin-plan/design.md:41; openspec/changes/new-api-checkin-plan/design.md:85; web/failure_reason.py:71; web/routes/logs.py:25; web/app.py:65; tests/test_failure_reason_classifier.py:13; README.md:172,受 Open Questions 影响：是否持久化分类字段待澄清; picked_reason:P1且可解锁NAP-04-02，先沉淀统一失败分类能力供前端复用; context_budget_exception:为确认日志展示层接入点与分类契约范围，context收集超过8次命令; review_initial:分类规则按auth>waf>network>unknown优先级并保留already_checked_in识别; review_regression:展示层计算error_category不改数据库结构，保留原始message可追溯; evidence:.venv/bin/pytest -q tests/test_failure_reason_classifier.py tests/test_provider_validation.py tests/test_checkin_branches.py tests/test_provider_integration.py -> 19 passed; risk:low 规则基于关键词可能存在边界误判，后续可按样本迭代关键词; done_at:2026-02-24
NAP-04-02,P1,4,frontend,前端展示失败归类 中文提示与已签到区分,在仪表盘和日志页展示失败分类标签与简要建议，保留原始错误文本，并把 already_checked_in 作为非动作提示。,WHEN 渲染失败日志 THEN 显示分类标签与简要说明并可查看原始 message; WHEN 渲染失败归类文案 THEN 使用中文; WHEN 增加徽标和提示块 THEN 保持现有页面风格; WHEN 结果为已签到 THEN 展示 already_checked_in 且不提示修复动作; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:25; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:33; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:37; ref: openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:44; validate: 手工验收各分类展示文案与样式,MANUAL,按决策5评审中文文案完整性与可理解性; 评审已签到提示是否与失败提示语义分离,回归检查新增提示块是否导致样式漂移与信息遮挡; 若风险出现可先隐藏提示块并保留原始 message,已完成,已完成,已完成,已提交,,openspec/changes/new-api-checkin-plan/tasks.md:32; openspec/changes/new-api-checkin-plan/tasks.md:34; openspec/changes/new-api-checkin-plan/tasks.md:35; openspec/changes/new-api-checkin-plan/specs/checkin-failure-reason-summary/spec.md:22; openspec/changes/new-api-checkin-plan/design.md:61; web/failure_reason.py:91; web/templates/logs.html:15; web/templates/logs.html:66; web/templates/dashboard.html:131; tests/test_failure_reason_classifier.py:33; README.md:173,Blocked by NAP-04-01 输出稳定分类; picked_reason:NAP-04-01已提供分类能力，现补齐前端展示与already_checked_in非动作提示; context_budget_exception:需联动日志页和仪表盘双模板并验证文案语义，context收集超过8次命令; review_initial:失败分类标签与中文提示统一由summarize_reason输出，already_checked_in标记为非动作提示; review_regression:新增提示块复用现有边框与色板样式，未引入主题或布局重设计; validation_limited:当前终端环境无法直接执行浏览器手工验收，MANUAL场景未实际点击回放; manual_test:打开仪表盘和日志页检查失败记录展示分类标签+中文提示+原始message入口，并确认already_checked_in显示为无需修复动作; evidence:.venv/bin/pytest -q tests/test_failure_reason_classifier.py tests/test_provider_validation.py tests/test_checkin_branches.py tests/test_provider_integration.py -> 20 passed; risk:medium 仅完成模板静态与单测验证，仍需真实UI点测确认信息密度与可读性; done_at:2026-02-24
NAP-05-01,P1,5,both,建立自动化测试与回归矩阵,补齐 new-api 签到流程 Provider 预设交互 日志导航筛选等测试，形成可重复执行的回归矩阵。,WHEN 运行签到流测试 THEN 覆盖 success already_checked_in auth_failure network_failure; WHEN 运行 Provider 表单测试 THEN 覆盖预设填充 覆盖保存 校验失败; WHEN 运行日志导航测试 THEN 验证从仪表盘到历史页与筛选翻页; validate: pytest -q 并记录失败用例,AUTOE2E,评审测试矩阵是否覆盖 proposal 与 specs 的关键 SHALL 场景; 明确边界场景与失败注入策略,回归按风险缓解策略覆盖 兼容性 样式一致性 查询性能 三类回归点; 发布前必须通过全量 smoke,未开始,未开始,未开始,未提交,,openspec/changes/new-api-checkin-plan/tasks.md:39; openspec/changes/new-api-checkin-plan/tasks.md:40; openspec/changes/new-api-checkin-plan/tasks.md:41; openspec/changes/new-api-checkin-plan/design.md:69; openspec/changes/new-api-checkin-plan/design.md:73,Blocked by NAP-01 至 NAP-04 关键功能完成
NAP-05-02,P2,5,infra,文档更新与发布回滚检查,更新多域名 new-api 配置与失败分类说明，完成发布清单 回滚清单 与视觉一致性复核项。,WHEN 完成文档更新 THEN 覆盖多域名配置步骤和失败分类说明; WHEN 执行发布检查 THEN 包含 rollout 与 rollback 清单; WHEN 进行 UI 复核 THEN 确认中文文案完整且无风格漂移; ref: openspec/changes/new-api-checkin-plan/tasks.md:42; ref: openspec/changes/new-api-checkin-plan/tasks.md:43; ref: openspec/changes/new-api-checkin-plan/tasks.md:44; ref: openspec/changes/new-api-checkin-plan/design.md:75; validate: 发布前人工走查清单,MANUAL,评审文档是否与当前实现一致并可操作; 记录未决问题的会议处理建议,回归要求包含回滚演练可执行性与应急路径清晰度; 若有未决 Open Questions 必须在发布备注中标注,未开始,未开始,未开始,未提交,,openspec/changes/new-api-checkin-plan/proposal.md:13; openspec/changes/new-api-checkin-plan/tasks.md:42; openspec/changes/new-api-checkin-plan/design.md:81; openspec/changes/new-api-checkin-plan/design.md:85,Open Questions: 是否持久化 error_category 及是否支持导出与自定义模板
